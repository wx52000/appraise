<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="wxx.java.appraise.dao.UserScoreDao">

    <insert id="add" parameterType="list">
        insert into user_score(grade_id , score_id , designer , personal , coordinate)
        values
        <foreach collection="list" item="item" index="index" separator=",">
        (#{item.gradeId} ,#{item.scoreId} , #{item.designer} ,#{item.personal} ,#{item.coordinate})
        </foreach>
    </insert>
    <insert id="appraise" parameterType="list">
        insert into user_score( grade_id , score_id , designer , personal , coordinate , `month` , `year` , `date` )
        value
        <foreach collection="list" item="item" index="index" separator=",">
            (#{item.gradeId} ,#{item.scoreId} , #{item.designer} ,#{item.personal} ,#{item.coordinate} ,#{month} ,#{year} , #{item.date})
        </foreach>
        ON DUPLICATE KEY UPDATE
        designer = values(designer),
        personal = values(personal),
        coordinate = values(coordinate),
        `month` = values(`month`),
        `year` = values(`year`),
        `date` = values(`date`)
    </insert>
    <insert id="backups">
        insert into user_score_backups(grade_id , score_id  , designer , personal , coordinate , `month` , `year`,date)
        select grade_id , score_id  , designer , personal , coordinate , `month` , `year`,date
        from user_score
    </insert>
    <delete id="del">
        delete
        from user_score
        where gs_id = #{gsId}
    </delete>
    <delete id="delete">
        delete
        from user_score
    </delete>

    <select id="queryByGradeId" resultType="java.util.Map" parameterType="user">
        select gs.id as id , gs.grade_id as gradeId , gs.score_id as scoreId ,
        CASE gs.state when 0 then "false"
        when  1 then "true" end as state ,
        u.name as name , d.name as department, t.name as technology,u.username,
        s.designer , s.personal , s.coordinate
        from user u,
        technology t,
        department d ,
        grade_score gs left join
        user_score s on s.gs_id = gs.id
        where gs.grade_id = #{id}
        and gs.score_id = u.id
        and u.did = d.id
        and u.tid = t.id
        <if test="queryByd != null and queryByd != ''">
        and u.did in
        <foreach collection="queryByd" item="item" separator="," open="(" close=")">
            #{item}
        </foreach>
        </if>
        <if test="queryByt != null and queryByt != ''">
            and u.tid in
            <foreach collection="queryByt" item="item" separator="," open="(" close=")">
                #{item}
            </foreach>
        </if>
        order by department , technology
    </select>
    <select id="queryByScoreId" resultType="java.util.Map">
    select `month`, if(designer=0,NULL,designer) as designer ,
    if(personal=0,NULL,personal) as personal
    ,IF(coordinate=0,NULL,coordinate) as coordinate,
          ( m.designer + m.personal + m.coordinate )/(
      3-m.bedei - m.beper - m.becoo) as score
    from (
    select `month`, IFNULL( round( AVG( designer ), 3 ), 0 ) AS designer,
        IFNULL( round( AVG( personal ), 3 ), 0 ) AS personal,
        IFNULL( round( AVG( coordinate ), 3 ), 0 ) AS coordinate,
        ISNULL(
        AVG( designer )) AS bedei,
        ISNULL(
        AVG( personal )) AS beper,
        ISNULL(
        AVG( coordinate )) AS becoo
    from user_score
    where score_id = #{id}) as m
    </select>
  <select id="queryByScoreIdPast" resultType="java.util.Map">
    select  if(`month`=0,NULL,`month`)as `month`, if(designer=0,NULL,designer) as designer ,
    if(personal=0,NULL,personal) as personal
    ,IF(coordinate=0,NULL,coordinate) as coordinate,
          ( m.designer + m.personal + m.coordinate )/(
      3-m.bedei - m.beper - m.becoo) as score
    from (
    select `month`,
        IFNULL( round( AVG( designer ), 3 ), 0 ) AS designer,
        IFNULL( round( AVG( personal ), 3 ), 0 ) AS personal,
        IFNULL( round( AVG( coordinate ), 3 ), 0 ) AS coordinate,
        ISNULL(
        AVG( designer )) AS bedei,
        ISNULL(
        AVG( personal )) AS beper,
        ISNULL(
        AVG( coordinate )) AS becoo
    from user_score_backups
    where score_id = #{id}) as m
    group by `month`
    order by `month` desc
    limit 2
  </select>
    <select id="queryScore" resultType="java.util.Map" parameterType="user">
        SELECT distinct m.sNAME AS name, m.department, m.technology, m.username,
      ( m.designer + m.personal + m.coordinate )/(
      3-m.bedei - m.beper - m.becoo) as score
        FROM(
        SELECT u.NAME AS sName, d.NAME AS department, t.NAME AS technology, u.username,
        s.score_id ,        IFNULL( round( AVG( designer ), 3 ), 0 ) AS designer,
      IFNULL( round( AVG( personal ), 3 ), 0 ) AS personal,
      IFNULL( round( AVG( coordinate ), 3 ), 0 ) AS coordinate,
      ISNULL(
      AVG( designer )) AS bedei,
      ISNULL(
      AVG( personal )) AS beper,
      ISNULL(
      AVG( coordinate )) AS becoo
        FROM
        user_score s,
        `USER` u,
        department d,
        technology t
        WHERE
        u.did = d.id
        AND u.tid = t.id
        AND s.score_id = u.id
      <if test="dIds != null and dIds != ''">
        and d.id in
        <foreach collection="dIds" item="item" separator="," close=")" open="(">
          #{item}
        </foreach>
      </if>
      <if test="tIds != null and tIds != ''">
        and t.id in
        <foreach collection="tIds" item="item" separator="," open="(" close=")">
          #{item}
        </foreach>
      </if>
      GROUP BY
      s.score_id) as m
      <if test="selectName != null and selectName != ''">
        order by ${selectName}
      </if>
      <if test="selectType == 1">
        desc
      </if>
        <where>
        <choose>
         <when test="pid == 1">
         </when>
         <otherwise>
        and m.score_id = #{id}
         </otherwise>
        </choose>
        </where>
    </select>
    <select id="queryScorePast" resultType="java.util.Map">
      SELECT distinct m.sNAME AS name, m.department, m.technology, m.username,
      ( m.designer + m.personal + m.coordinate )/(
      3-m.bedei - m.beper - m.becoo) as score
      FROM(
      SELECT u.NAME AS sName, d.NAME AS department, t.NAME AS technology, u.username,
      s.score_id , IFNULL( round( AVG( designer ), 3 ), 0 ) AS designer,
      IFNULL( round( AVG( personal ), 3 ), 0 ) AS personal,
      IFNULL( round( AVG( coordinate ), 3 ), 0 ) AS coordinate,
      ISNULL(
      AVG( designer )) AS bedei,
      ISNULL(
      AVG( personal )) AS beper,
      ISNULL(
      AVG( coordinate )) AS becoo
      FROM
      user_score_backups s,
      `USER` u,
      department d,
      technology t
      WHERE
      u.did = d.id
      AND u.tid = t.id
      AND s.score_id = u.id
      AND s.month = #{thisMonth}
      AND S.year = #{thisYear}
      <if test="dIds != null and dIds != ''">
        and d.id in
        <foreach collection="dIds" item="item" separator="," close=")" open="(">
          #{item}
        </foreach>
      </if>
      <if test="tIds != null and tIds != ''">
        and t.id in
        <foreach collection="tIds" item="item" separator="," open="(" close=")">
          #{item}
        </foreach>
      </if>
        GROUP BY
        s.score_id) as m
      <if test="selectName != null and selectName != ''">
        order by ${selectName}
      </if>
      <if test="selectType == 1">
        desc
      </if>
      <where>
        <choose>
          <when test="pid == 1">
          </when>
          <otherwise>
            and m.score_id = #{id}
          </otherwise>
        </choose>
      </where>
    </select>
    <select id="query" resultType="java.util.Map">
        select m.sname , m.department , m.technology , m .designer ,
         m.personal , u.name as gname , m.coordinate
        from (select u.name as sname, d.name as department , t.name as technology ,
        designer , personal , s.grade_id , coordinate
        from
        user_score s,
        `user` u,
        department d,
        technology t
        where
        u.did = d.id
        and u.tid = t.id
        and s.score_id = u.id
      <if test="dIds != null and dIds != ''">
        and d.id in
        <foreach collection="dIds" item="item" separator="," close=")" open="(">
          #{item}
        </foreach>
      </if>
      <if test="tIds != null and tIds != ''">
        and t.id in
        <foreach collection="tIds" item="item" separator="," open="(" close=")">
          #{item}
        </foreach>
      </if>
        ) as m,
        user  u
        where
        m.grade_id = u.id
      <if test="selectName != null and selectName != ''">
        order by ${selectName}
      </if>
      <if test="selectType == 1">
        desc
      </if>
    </select>
    <select id="queryPast" resultType="java.util.Map">
      select m.sname , m.department , m.technology , m .designer ,
      m.personal , u.name as gname , m.coordinate
      from (select u.name as sname, d.name as department , t.name as technology ,
      designer , personal , s.grade_id , coordinate
      from
      user_score_backups s,
      `user` u,
      department d,
      technology t
      where
      u.did = d.id
      and u.tid = t.id
      and s.score_id = u.id
      AND s.month = #{thisMonth}
      AND S.year = #{thisYear}
      <if test="dIds != null and dIds != ''">
        and d.id in
        <foreach collection="dIds" item="item" separator="," close=")" open="(">
          #{item}
        </foreach>
      </if>
      <if test="tIds != null and tIds != ''">
        and t.id in
        <foreach collection="tIds" item="item" separator="," open="(" close=")">
          #{item}
        </foreach>
      </if>
      ) as m,
      user  u
      where
      m.grade_id = u.id
      <if test="selectName != null and selectName != ''">
        order by ${selectName}
      </if>
      <if test="selectType == 1">
        desc
      </if>
    </select>
    <select id="excel1" resultType="wxx.java.appraise.entity.PersonalExcel" parameterType="user">
        select name, department, technology, username,m.score_id,
            ( m.designer + m.personal + m.coordinate )/(
        3-m.bedei - m.beper - m.becoo) as score
        from (SELECT u.NAME AS name, d.NAME AS department, t.NAME AS technology, u.username,
        s.score_id,
        IFNULL( round( AVG( designer ), 3 ), 0 ) AS designer,
        IFNULL( round( AVG( personal ), 3 ), 0 ) AS personal,
        IFNULL( round( AVG( coordinate ), 3 ), 0 ) AS coordinate,
        ISNULL(
        AVG( designer )) AS bedei,
        ISNULL(
        AVG( personal )) AS beper,
        ISNULL(
        AVG( coordinate )) AS becoo
        FROM
        user_score s,
        `USER` u,
        department d,
        technology t
        WHERE
        u.did = d.id
        AND u.tid = t.id
        AND s.score_id = u.id
        GROUP BY
        s.score_id) as m
    </select>
  <select id="excel2" resultType="wxx.java.appraise.entity.PersonalExcel">
        select name, department, technology, username,m.score_id,
            ( m.designer + m.personal + m.coordinate )/(
        3-m.bedei - m.beper - m.becoo) as score
        from (SELECT u.NAME AS name, d.NAME AS department, t.NAME AS technology, u.username,
        s.score_id,
        IFNULL( round( AVG( designer ), 3 ), 0 ) AS designer,
        IFNULL( round( AVG( personal ), 3 ), 0 ) AS personal,
        IFNULL( round( AVG( coordinate ), 3 ), 0 ) AS coordinate,
        ISNULL(
        AVG( designer )) AS bedei,
        ISNULL(
        AVG( personal )) AS beper,
        ISNULL(
        AVG( coordinate )) AS becoo
        FROM
        user_score_backups s,
        `USER` u,
        department d,
        technology t
        WHERE
        u.did = d.id
        AND u.tid = t.id
        AND s.score_id = u.id
        AND s.month = #{thisMonth}
        AND S.year = #{thisYear}
        GROUP BY
        s.score_id) as m
  </select>
  <select id="detail" resultType="java.lang.String">
    SELECT
      CONCAT_WS( ',', designer, personal, coordinate ) ,u.username
      FROM
        `user` u
        LEFT JOIN user_score s ON u.id = s.grade_id
        AND s.score_id = #{id}
    WHERE
      u.grade = 1
    ORDER BY u.username
  </select>
  <select id="detailPast" resultType="java.lang.String">
    SELECT
      CONCAT_WS( ',', designer, personal, coordinate ) ,u.username
      FROM
        `user` u
        LEFT JOIN user_score_backups s ON u.id = s.grade_id
        AND s.score_id = #{uid}
        AND s.month = #{user.thisMonth}
        AND S.year = #{user.thisYear}
    WHERE
      u.grade = 1
    ORDER BY u.username
  </select>
  <select id="part0" resultType="wxx.java.appraise.entity.PartExcel">
    select u1.name as grade , u2.name as score ,us.personal,us.designer,us.coordinate ,
    d.name as dep , t.name as tec
    from
    `user` u1,
    `user` u2,
    user_score us,
    department d,
    technology t
    where
    u1.id = us.grade_id
    and u2.id = us.score_id
    and d.id = u2.did
    and t.id = u2.tid
    <if test="users != null and users != ''">
      and u1.id in
      <foreach collection="users" item="item" separator="," open="(" close=")">
        #{item}
      </foreach>
    </if>
  </select>
  <select id="partPast0" resultType="wxx.java.appraise.entity.PartExcel">
    select u1.name as grade , u2.name as score ,us.personal,us.designer,us.coordinate ,
    d.name as dep , t.name as tec
    from
    `user` u1,
    `user` u2,
    user_score_backups us,
    department d,
    technology t
    where
    u1.id = us.grade_id
    and u2.id = us.score_id
    and d.id = u2.did
    and t.id = u2.tid
    AND us.month = #{thisMonth}
    AND uS.year = #{thisYear}
    <if test="users != null and users != ''">
      and u1.id in
      <foreach collection="users" item="item" separator="," open="(" close=")">
        #{item}
      </foreach>
    </if>
  </select>
  <select id="part1" resultType="wxx.java.appraise.entity.PartExcel">
    select u1.name as grade , u2.name as score ,us.personal,us.designer,us.coordinate ,
    d.name as dep , t.name as tec
    from
    `user` u1,
    `user` u2,
    user_score us,
    department d,
    technology t
    where
    u1.id = us.grade_id
    and u2.id = us.score_id
    and d.id = u2.did
    and t.id = u2.tid
    <if test="users != null and users != ''">
      and u2.id in
      <foreach collection="users" item="item" separator="," open="(" close=")">
        #{item}
      </foreach>
    </if>
  </select>
  <select id="partPast1" resultType="wxx.java.appraise.entity.PartExcel">
    select u1.name as grade , u2.name as score ,us.personal,us.designer,us.coordinate ,
    d.name as dep , t.name as tec
    from
    `user` u1,
    `user` u2,
    user_score_backups us,
    department d,
    technology t
    where
    u1.id = us.grade_id
    and u2.id = us.score_id
    and d.id = u2.did
    and t.id = u2.tid
    AND us.month = #{thisMonth}
    AND uS.year = #{thisYear}
    <if test="users != null and users != ''">
      and u2.id in
      <foreach collection="users" item="item" separator="," open="(" close=")">
        #{item}
      </foreach>
    </if>
  </select>


</mapper>
