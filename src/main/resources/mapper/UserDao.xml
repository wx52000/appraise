<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="wxx.java.appraise.dao.UserDao">
    <resultMap  id="tecUser" type="technology">
        <result column="tid" property="id" jdbcType="INTEGER"/>
        <result column="name" property="name" jdbcType="VARCHAR"/>
        <collection property="list" javaType="ARRAYLIST"
                    column="tid" select="getPrincipal"/>
    </resultMap>
    <resultMap  id="GroupUser" type="java.util.Map">
      <result column="id" property="id" jdbcType="INTEGER"/>
      <result column="label" property="label" jdbcType="VARCHAR"/>
      <result column="vid" property="vid" jdbcType="VARCHAR"/>
      <collection property="group" javaType="ARRAYLIST"
                  column="id=id,vid= vid" select="getGroup"/>
    </resultMap>
  <resultMap  id="GroupUser1" type="java.util.Map">
    <result column="id" property="id" jdbcType="INTEGER"/>
    <result column="label" property="label" jdbcType="VARCHAR"/>
    <result column="vid" property="vid" jdbcType="VARCHAR"/>
    <collection property="group" javaType="ARRAYLIST"
                column="id=id,vid= vid" select="getGroup1"/>
  </resultMap>
    <insert id="add" parameterType="user" useGeneratedKeys="true" keyProperty="id">
        insert into user(pid , did , tid , `name` , username , paw , grade)
        values (#{pid} , #{did} , #{tid} , #{name} , #{username} , "1234" , #{grade})
    </insert>
    <insert id="addExcel" parameterType="list" useGeneratedKeys="true" keyProperty="id">
        insert into user(pid , did , tid , `name` , username ,grade)
        value
        <foreach collection="list" index="index" item="item" separator=",">
        ( 4, #{item.department} , #{item.technology} , #{item.name} , #{item.username} , #{item.grade})
        </foreach>
        ON DUPLICATE KEY UPDATE
        did = values(did),
        tid = values(tid),
        grade = values(grade)
    </insert>
    <update id="upd">
        update `user`
        <set>
            <if test="pid != null and pid !=''">
                pid = #{pid},
            </if>
            <if test="did != null and did !=''">
                did = #{did},
            </if>
            <if test="tid != null and tid !=''">
                tid = #{tid},
            </if>
            <if test="grade != null">
            grade = #{grade,jdbcType=INTEGER},
            </if>
        </set>
        <where> id = #{id}
        </where>
    </update>
    <update id="paw">
        update user
        set paw = #{paw} , paw_state = 1
        where id = #{id}
    </update>
    <delete id="del">
        delete u , s
        from  `user` u
        left  join  grade_score s on u.id = s.score_id
        where u.id = #{id}
    </delete>
    <select id="login" resultType="java.util.Map">
    SELECT
      u.`name`,
      u.id,
      pid,
      paw_state AS pawState,
      tid,
      did,
      GROUP_CONCAT(up.position_id) AS `position`,
      u.grade
    FROM
      `user` u
      LEFT JOIN user_position up ON up.user_id = u.id
      LEFT JOIN `position` p ON p.id = up.position_id
    WHERE
      u.username = #{username}
      AND u.paw = #{paw}
    ORDER BY
      p.id
    </select>
    <select id="queryById" resultType="wxx.java.appraise.entity.User">
        select *
        from `user`
        where id = #{id}
    </select>
    <select id="query" resultType="java.util.Map" parameterType="user">
      select u.id , u.name , u.username, u.grade, d.name as department ,
      t.name as technology , p.name as power ,GROUP_CONCAT(pt.`name`) as `position`
      from `user` u left join
      user_position up on u.id = up.user_id
      left join `position` pt on pt.id = up.position_id,
      technology t ,
      power p ,
      department d
      where u.pid = p.id
      and u.tid = t.id
      and u.did = d.id
        <if test="name != null and name != ''">
        and u.name like concat("%",#{name},"%")
        </if>
        <if test="username != null and username != ''">
            and u.username like concat("%",#{username},"%")
        </if>
        <if test="dIds != null and dIds != ''">
            and d.id in
            <foreach collection="dIds" item="item" separator="," close=")" open="(">
                #{item}
            </foreach>
        </if>
        <if test="tIds != null and tIds != ''">
            and t.id in
            <foreach collection="tIds" item="item" separator="," open="(" close=")">
                #{item}
            </foreach>
        </if>
      <if test="pIds != null and pIds != ''">
        and pt.id in
        <foreach collection="pIds" item="item" separator="," open="(" close=")">
          #{item}
        </foreach>
      </if>
      GROUP BY u.id
        <if test="selectName != null and selectName != ''">
            order by ${selectName}
        </if>
        <if test="selectType == 1">
        desc
        </if>
    </select>
    <select id="queryByTid" resultType="java.util.Map">
        select id , `name` , username
        from  `user`
        where tid = #{id}
    </select>
    <select id="queryNotScore" resultType="java.util.Map" parameterType="user">
        select u.id , u.name , username , d.name as department , t.name as technology,
        IFNULL (s.grade_id, 0 ) as selected
        from  `user` u left join
        grade_score s on u.id = score_id and s.grade_id = #{id},
        department d,
        technology t
        where
        u.id &lt;&gt; #{id}
        and d.id = u.did
        and t.id = u.tid
        <if test="dIds != null and dIds != ''">
            and d.id in
            <foreach collection="dIds" item="item" separator="," close=")" open="(">
                #{item}
            </foreach>
        </if>
        <if test="tIds != null and tIds != ''">
            and t.id in
            <foreach collection="tIds" item="item" separator="," open="(" close=")">
                #{item}
            </foreach>
        </if>
        <if test="name != null and name !=''">
        and u.name like BINARY concat("%",#{name},"%")
        </if>
        <if test="username != null and username != ''">
        and u.username like concat("%",#{username},"%")
        </if>
    </select>
    <select id="queryByUsername" resultType="java.lang.Integer" parameterType="list">
    select id
    from user
    where username in
        <foreach collection="list" item="user" index="index" open="(" separator="," close=")">
        #{user.username}
        </foreach>
    </select>
    <select id="queryByTec" resultType="java.util.Map">
        select id as `value` , `name` as label
        from
        `user`
        where tid = #{id}
    </select>
    <select id="queryPrincipal" resultType="map" >
    SELECT DISTINCT
        pt.tec_id AS tid,
        pu.user_id AS uid
    FROM
        project_tec pt
        LEFT JOIN (
        SELECT
            u.tid,
            pu.project_id,
            pu.user_id
        FROM
            project_user pu,
            `user` u
        WHERE
            pu.power_id = 2
            AND pu.user_id = u.id
        ) AS pu on pt.project_id = pu.project_id and pt.tec_id = pu.tid
    WHERE
        pt.project_id = #{id}
    </select>
    <select id="queryByName" resultType="java.util.Map">
        select id  , `name`
        from
        `user`
        where `name` like concat("%",#{name},"%")
        union distinct
        select id  , `name`
        from
        `user`
        where `username` like concat("%",#{name},"%")
    </select>
    <select id="selectByName" resultType="java.lang.Integer">
        select id
        from `user`
        where `name` = #{name}
    </select>
  <select id="queryNotSelf" resultType="java.util.Map">
        select distinct u.id , u.name as name, u.username ,
        d.name as department , t.name as technology ,
        us.designer , us.personal , us.coordinate
        from `user` u left join
        user_score us on us.grade_id = #{id} and u.id = us.score_id ,
        department d,
        technology t
        where u.id &lt;&gt; #{id}
        and u.did = d.id
        and u.tid = t.id
        and not exists(
        select id
        from score_manage sm
        where sm.score_id = #{id}
        and sm.scored_id = u.id
        and sm.state = 1
    )
    <if test="selectName != null and selectName != ''">
      and (u.name like concat("%",#{selectName},"%")
      or u.username like concat("%",#{selectName},"%"))
    </if>
  </select>
  <select id="queryByGAndP" resultType="java.util.Map">
    select *
    from (
    SELECT
    v.designer AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate,
    13 as role
    FROM
    volume v,
    project p,
    `USER` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    WHERE
    p.id = v.project_id
    AND u.`name` = v.designer
    AND u.id &lt;&gt; #{id}
    AND u.did = d.id
    AND u.tid = t.id
    AND FIND_IN_SET(#{name},REPLACE (p.general, ";", "," ))
    AND ((
    v.shot_date != ""
    AND ( v.planned_start_date >= #{sqlDate} OR v.start_date >= #{sqlDate} OR v.shot_date >= #{sqlDate} OR
    v.actual_publication_date >= #{sqlDate} ))
    OR ( v.shot_date = "" AND v.start_date != "" )) UNION
    SELECT
    principal AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate,
    13 as role
    FROM
    project p,
    volume v,
    `user` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    WHERE
    FIND_IN_SET(#{name},REPLACE (p.general, ";", "," ))
    AND p.id = v.project_id
    AND u.id &lt;&gt; #{id}
    AND u.did = d.id
    AND u.tid = t.id
    AND u.`name` = v.principal
    AND v.principal NOT LIKE "%;%" UNION
    SELECT
    SUBSTRING_INDEX( v.principal, ";", 1 ) AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate,
    13 as role
    FROM
    volume v,
    project p,
    `user` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    WHERE
    p.id = v.project_id
    AND u.id &lt;&gt; #{id}
    AND u.did = d.id
    AND u.tid = t.id
    AND FIND_IN_SET(#{name},REPLACE (p.general, ";", "," ))
    AND u.`name` = SUBSTRING_INDEX( v.principal, ";", 1 )
    AND v.principal LIKE "%;%" UNION
    SELECT
    SUBSTRING_INDEX( v.principal, ";",- 1 ) AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate,
    13 as role
    FROM
    project p,
    volume v,
    `user` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    WHERE
    p.id = v.project_id
    AND u.id &lt;&gt; #{id}
    AND u.did = d.id
    AND u.tid = t.id
    AND FIND_IN_SET(#{name},REPLACE (p.general, ";", "," ))
    AND u.`name` = SUBSTRING_INDEX( v.principal, ";",- 1 )
    AND v.principal LIKE "%;%" UNION
    SELECT
    p.general AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate,
    13 as role
    FROM
    project p,
    volume v,
    `user` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    WHERE
    FIND_IN_SET(#{name},REPLACE (p.general, ";", "," ))
    AND p.id = v.project_id
    AND u.id &lt;&gt; #{id}
    AND u.did = d.id
    AND u.tid = t.id
    AND u.`name` = p.general
    AND p.general NOT LIKE "%;%" UNION
    SELECT
    SUBSTRING_INDEX( p.general, ";", 1 ) AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate,
    13 as role
    FROM
    project p,
    volume v,
    `user` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    WHERE
    FIND_IN_SET(#{name},REPLACE (p.general, ";", "," ))
    AND p.id = v.project_id
    AND u.id &lt;&gt; #{id}
    AND u.`name` = SUBSTRING_INDEX( p.general, ";", 1 )
    AND p.general LIKE "%;%" UNION
    SELECT
    SUBSTRING_INDEX( p.general, ";", - 1 ) AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate,
    13 as role
    FROM
    project p,
    volume v,
    `user` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    WHERE
    FIND_IN_SET(#{name},REPLACE (p.general, ";", "," ))
    AND p.id = v.project_id
    AND u.id &lt;&gt; #{id}
    AND u.did = d.id
    AND u.tid = t.id
    AND u.`name` = SUBSTRING_INDEX( p.general, ";", - 1 )
    AND p.general LIKE "%;%" union
    SELECT
    v.designer AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate,
    14 as role
    FROM
    volume v,
    project p,
    `USER` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    WHERE
    p.id = v.project_id
    AND u.`name` = v.designer
    AND u.id &lt;&gt; #{id}
    AND u.did = d.id
    AND u.tid = t.id
    AND p.id in (
    SELECT
    project_id
    FROM
    volume
    WHERE
    FIND_IN_SET(#{name},REPLACE (principal, ";", "," ))
    )
    AND ((
    v.shot_date != ""
    AND ( v.planned_start_date >= #{sqlDate} OR v.start_date >= #{sqlDate} OR v.shot_date >= #{sqlDate} OR
    v.actual_publication_date >= #{sqlDate} ))
    OR ( v.shot_date = "" AND v.start_date != "" )) UNION
    SELECT
    principal AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate,
    14 as role
    FROM
    project p,
    volume v,
    `user` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    WHERE
    p.id in (
    SELECT
    project_id
    FROM
    volume
    WHERE
    FIND_IN_SET(#{name},REPLACE (principal, ";", "," ))
    )
    AND p.id = v.project_id
    AND u.id &lt;&gt; #{id}
    AND u.did = d.id
    AND u.tid = t.id
    AND u.`name` = v.principal
    AND v.principal NOT LIKE "%;%" UNION
    SELECT
    SUBSTRING_INDEX( v.principal, ";", 1 ) AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate,
    14 as role
    FROM
    volume v,
    project p,
    `user` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    WHERE
    p.id = v.project_id
    AND u.id &lt;&gt; #{id}
    AND u.did = d.id
    AND u.tid = t.id
    AND p.id in (
    SELECT
    project_id
    FROM
    volume
    WHERE
    FIND_IN_SET(#{name},REPLACE (principal, ";", "," ))
    )
    AND u.`name` = SUBSTRING_INDEX( v.principal, ";", 1 )
    AND v.principal LIKE "%;%" UNION
    SELECT
    SUBSTRING_INDEX( v.principal, ";",- 1 ) AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate,
    14 as role
    FROM
    project p,
    volume v,
    `user` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    WHERE
    p.id = v.project_id
    AND u.id &lt;&gt; #{id}
    AND u.did = d.id
    AND u.tid = t.id
    AND p.id in (
    SELECT
    project_id
    FROM
    volume
    WHERE
    FIND_IN_SET(#{name},REPLACE (principal, ";", "," ))
    )
    AND u.`name` = SUBSTRING_INDEX( v.principal, ";",- 1 )
    AND v.principal LIKE "%;%" UNION
    SELECT
    p.general AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate,
    14 as role
    FROM
    project p,
    volume v,
    `user` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    WHERE
    p.id in (
    SELECT
    project_id
    FROM
    volume
    WHERE
    FIND_IN_SET(#{name},REPLACE (principal, ";", "," ))
    )
    AND p.id = v.project_id
    AND u.id &lt;&gt; #{id}
    AND u.did = d.id
    AND u.tid = t.id
    AND u.`name` = p.general
    AND p.general NOT LIKE "%;%" UNION
    SELECT
    SUBSTRING_INDEX( p.general, ";", 1 ) AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate,
    14 as role
    FROM
    project p,
    volume v,
    `user` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    WHERE
    p.id in (
    SELECT
    project_id
    FROM
    volume
    WHERE
    FIND_IN_SET(#{name},REPLACE (principal, ";", "," ))

    )
    AND p.id = v.project_id
    AND u.id &lt;&gt; #{id}
    AND u.`name` = SUBSTRING_INDEX( p.general, ";", 1 )
    AND p.general LIKE "%;%" UNION
    SELECT
    SUBSTRING_INDEX( p.general, ";", - 1 ) AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate,
    14 as role
    FROM
    project p,
    volume v,
    `user` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    WHERE
    p.id in (
    SELECT
    project_id
    FROM
    volume
    WHERE
    FIND_IN_SET(#{name},REPLACE (principal, ";", "," ))

    )
    AND p.id = v.project_id
    AND u.id &lt;&gt; #{id}
    AND u.did = d.id
    AND u.tid = t.id
    AND u.`name` = SUBSTRING_INDEX( p.general, ";", - 1 )
    AND p.general LIKE "%;%"
    union
    select
    u.name AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate,
    13 as role
    from
    score_manage sm,
    `user` u left join
    user_score us on u.id = score_id and grade_id = #{id},
    department d,
    technology t
    where
    sm.score_id = #{id}
    and sm.scored_id = u.id
    and u.did = d.id
    and u.tid = t.id
    and sm.state = 0
    ) as d
    <where>
    not exists(
        select id
        from score_manage sm
        where sm.score_id = #{id}
        and sm.scored_id = d.id
        and sm.state = 1
      )
      <if test="selectName != null and selectName != ''">
      and(  d.name like concat("%",#{selectName},"%")
        or
        d.username like concat("%",#{selectName},"%"))
      </if>
    </where>
    group by  d.username
  </select>
  <select id="queryToupd" resultType="java.util.Map">
    select u.id , u.name , u.username , u.grade , d.name as department , t.name as technology , p.name as power
        from `user` u,
        technology t ,
        power p ,
        department d
        where u.pid = p.id
        and u.tid = t.id
        and u.did = d.id
        and u.id = #{id}
  </select>
  <select id="queryPosition" resultType="java.util.Map">
    select up.id , p.id as `position` , p.name, up.department_id , d.`name` as dep
    from `position` p,
		user_position up	LEFT JOIN
    department d on d.id = up.department_id
    where
    p.id = up.position_id
    and up.user_id = #{id}
  </select>
  <select id="queryNotAppraise" resultType="wxx.java.appraise.entity.UserOut">
SELECT DISTINCT
	u.id,
	u.`name`,
	username,
	d.NAME AS department,
	t.NAME AS technology
FROM
	`user` u,
	department d,
	technology t,
	(
	SELECT
		principal AS `name`
	FROM
		volume v
	WHERE
		v.planned_start_date >= #{sqlDate}
		OR v.start_date >= #{sqlDate}
		OR v.shot_date >= #{sqlDate}
		OR v.actual_publication_date >= #{sqlDate}
		OR ( v.shot_date = "" AND v.start_date != "" ) UNION
	SELECT
		SUBSTRING_INDEX( v.principal, ";", 1 ) AS `name`
	FROM
		volume v
	WHERE
		v.planned_start_date >= #{sqlDate}
		OR v.start_date >= #{sqlDate}
		OR v.shot_date >= #{sqlDate}
		OR v.actual_publication_date >= #{sqlDate}
		OR ( v.shot_date = "" AND v.start_date != "" ) UNION
	SELECT
		SUBSTRING_INDEX( v.principal, ";", - 1 ) AS `name`
	FROM
		volume v
	WHERE
		v.planned_start_date >= #{sqlDate}
		OR v.start_date >= #{sqlDate}
		OR v.shot_date >= #{sqlDate}
		OR v.actual_publication_date >= #{sqlDate}
		OR ( v.shot_date = "" AND v.start_date != "" ) UNION
	SELECT
		general AS `name`
	FROM
		project UNION
	SELECT
		SUBSTRING_INDEX( general, ";",- 1 ) AS `name`
	FROM
		project UNION
	SELECT
		SUBSTRING_INDEX( general, ";",- 1 ) AS `name`
	FROM
		project
	) AS human,
	( SELECT DISTINCT user_id FROM user_position ) AS up
WHERE
	( u.`name` = human.`name` OR u.id = up.user_id )
	AND u.did = d.id
	AND u.tid = t.id
	and not EXISTS(
	SELECT  id
	FROM user_score us
	WHERE u.id = us.grade_id)
  </select>
  <select id="queryNotScored" resultType="wxx.java.appraise.entity.UserOut">
    select u.`name` , username , d.name as department ,t.name as technology
    from `user` u,
    department d,
    technology t
    where
     u.did = d.id
    and u.tid = t.id
    and not exists (select id
    from user_score s
    where u.id = s.score_id
    )
    <if test="dIds != null and dIds != ''">
      and d.id in
      <foreach collection="dIds" item="item" separator="," close=")" open="(">
        #{item}
      </foreach>
    </if>
    <if test="tIds != null and tIds != ''">
      and t.id in
      <foreach collection="tIds" item="item" separator="," open="(" close=")">
        #{item}
      </foreach>
    </if>
    <if test="selectName != null and selectName != ''">
      order by ${selectName}
    </if>
    <if test="selectType == 1">
      desc
    </if>
    </select>
  <select id="queryNotTecApp" resultType="wxx.java.appraise.entity.UserOut">
    select u.`name` , username , d.name as department ,t.name as technology
    from `user` u,
    department d,
    technology t
    where
    u.grade = 1
    and u.did = d.id
    and u.tid = t.id
    and not exists (select id
    from tec_score s
    where u.id = s.grade_id
    )
    <if test="dIds != null and dIds != ''">
      and d.id in
      <foreach collection="dIds" item="item" separator="," close=")" open="(">
        #{item}
      </foreach>
    </if>
    <if test="tIds != null and tIds != ''">
      and t.id in
      <foreach collection="tIds" item="item" separator="," open="(" close=")">
        #{item}
      </foreach>
    </if>
    <if test="selectName != null and selectName != ''">
      order by ${selectName}
    </if>
    <if test="selectType == 1">
      desc
    </if>
  </select>
  <select id="queryAppriseAll" resultType="java.util.Map">
    SELECT DISTINCT
      u.id,
      u.`name`,
      username,
        d.id as did,
        t.id as tid,
      d.NAME AS department,
      t.NAME AS technology
    FROM
      `user` u,
      department d,
      technology t,
      (
        SELECT
          principal AS `name`
        FROM
          volume v
        WHERE
          v.planned_start_date >= #{sqlDate}
           OR v.start_date >= #{sqlDate}
           OR v.shot_date >= #{sqlDate}
           OR v.actual_publication_date >= #{sqlDate}
           OR ( v.shot_date = "" AND v.start_date != "" ) UNION
        SELECT
          SUBSTRING_INDEX( v.principal, ";", 1 ) AS `name`
        FROM
          volume v
        WHERE
          v.planned_start_date >= #{sqlDate}
           OR v.start_date >= #{sqlDate}
           OR v.shot_date >= #{sqlDate}
           OR v.actual_publication_date >= #{sqlDate}
           OR ( v.shot_date = "" AND v.start_date != "" ) UNION
        SELECT
          SUBSTRING_INDEX( v.principal, ";", - 1 ) AS `name`
        FROM
          volume v
        WHERE
          v.planned_start_date >= #{sqlDate}
           OR v.start_date >= #{sqlDate}
           OR v.shot_date >= #{sqlDate}
           OR v.actual_publication_date >= #{sqlDate}
           OR ( v.shot_date = "" AND v.start_date != "" ) UNION
        SELECT
          general AS `name`
        FROM
          project UNION
        SELECT
          SUBSTRING_INDEX( general, ";",- 1 ) AS `name`
        FROM
          project UNION
        SELECT
          SUBSTRING_INDEX( general, ";",- 1 ) AS `name`
        FROM
          project
      ) AS human,
      ( SELECT DISTINCT user_id FROM user_position ) AS up
    WHERE
      ( u.`name` = human.`name` OR u.id = up.user_id )
      AND u.did = d.id
      AND u.tid = t.id
  </select>
  <select id="queryAppraise" resultType="wxx.java.appraise.entity.UserOut">
    select distinct u.`name` , username , d.name as department ,t.name as technology
    from `user` u,
    department d,
    technology t,
		user_score us
    where
     u.did = d.id
    and u.tid = t.id
    and us.grade_id = u.id
    </select>
  <select id="queryGrade" resultType="java.lang.String">
    SELECT `name`
    FROM `user` u
    WHERE
      EXISTS (
        SELECT	id
        FROM
          volume
        WHERE
          FIND_IN_SET(u.name,REPLACE (`principal`, ";", "," )) UNION
        SELECT id
        FROM
          project
        WHERE
          FIND_IN_SET(u.name,REPLACE (`general`, ";", "," )))
    ORDER BY username
  </select>
  <select id="queryAll" resultType="java.util.Map">
    SELECT id , `name`
    FROM `user`
    ORDER BY username
  </select>
  <select id="queryByT" resultType="java.util.Map">
    select concat_ws("-",t.did, t.id ,u.id ) as id,
     concat_ws("-",t.did, t.id) as pid,
     u.name as label
     from `user` u,
     technology t
     where t.id = #{id}
     and u.tid = t.id
     <if test="mode == 0 ">
       AND EXISTS (
       SELECT	id
       FROM
       volume
       WHERE
       FIND_IN_SET(u.name,REPLACE (`principal`, ";", "," )) UNION
       SELECT id
       FROM
       project
       WHERE
       FIND_IN_SET(u.name,REPLACE (`general`, ";", "," )))
     </if>
  </select>
  <select id="queryByTAndState" resultType="java.util.Map">
    select concat_ws("-",t.did, t.id ,u.id ) as id,
           u.name as label, sm.state as state
    from
    technology t,
    `user` u LEFT JOIN
    score_manage sm on u.id = sm.scored_id and sm.score_id = #{id}
    where t.id = #{tid}
    and u.tid = t.id
  </select>
  <select id="queryByTAndGroup" resultMap="GroupUser">
    select
           u.name as label , u.id as id,
           case when #{vid} Is Null then Null
            else #{vid} end as vid
    from
      technology t,
      `user` u
    where t.id = #{tid}
      and u.tid = t.id
  </select>
  <select id="getGroup" resultType="java.lang.Integer">
    select distinct v.user_id
    from virtual_leader v
    where  `group` = (select `group`
                      from virtual_leader
                      where user_id = #{id}
                        and virtual_id = #{vid})
      and virtual_id = #{vid}
      and v.user_id &lt;&gt; #{id}
  </select>
  <select id="queryByTAndGroup1" resultMap="GroupUser1">
    select
      u.name as label , u.id as id,
      case when #{vid} Is Null then Null
           else #{vid} end as vid
    from
      technology t,
      `user` u
    where t.id = #{tid}
      and u.tid = t.id
  </select>
  <select id="getGroup1" resultType="java.lang.Integer">
    select distinct v.user_id
    from activity_leader v
    where  `group` = (select `group`
                      from activity_leader
                      where user_id = #{id}
                        and activity_id = #{vid})
      and activity_id = #{vid}
      and v.user_id &lt;&gt; #{id}
  </select>
  <select id="queryLimits" resultType="java.util.Map">
    SELECT
      u.id AS uid,
      u.grade,
      u.did AS did,
      p.`name` AS `position`,
      p.limits,
      d.`name` AS department,
      d.branch
    FROM
      `user` u
      LEFT JOIN user_position up ON u.id = up.user_id
      LEFT JOIN position p ON p.id = up.position_id
      LEFT JOIN department d ON d.id = up.department_id
    WHERE
      u.id = #{id}
    ORDER BY
      p.`limits`
      LIMIT 1
  </select>
  <select id="queryByDirector" resultType="java.util.Map">
    select
    u.name AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate
    from
    `user` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    where
    d.id in ${branch}
    AND u.id &lt;&gt; #{id}
    and d.id= u.did
    and u.tid = t.id
    union
    SELECT
    v.designer AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate
    FROM
    volume v,
    project p,
    `USER` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    WHERE
    p.id = v.project_id
    AND u.`name` = v.designer
    AND u.id &lt;&gt; #{id}
    AND u.did = d.id
    AND u.tid = t.id
    AND (
      FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
    or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))
    )
    AND ((
    v.shot_date != ""
    AND ( v.planned_start_date >= #{sqlDate} OR v.start_date >= #{sqlDate} OR v.shot_date >= #{sqlDate} OR v.actual_publication_date >= #{sqlDate} ))
    OR ( v.shot_date = "" AND v.start_date != "" )) UNION
    SELECT
    principal AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate
    FROM
    project p,
    volume v,
    `user` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    WHERE

     (
         FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
         or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))

    )
    AND p.id = v.project_id
    AND u.id &lt;&gt; #{id}
    AND u.did = d.id
    AND u.tid = t.id
    AND u.`name` = v.principal
    AND v.principal NOT LIKE "%;%" UNION
    SELECT
    SUBSTRING_INDEX( v.principal, ";", 1 ) AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate
    FROM
    volume v,
    project p,
    `user` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    WHERE
    p.id = v.project_id
    AND u.id &lt;&gt; #{id}
    AND u.did = d.id
    AND u.tid = t.id
    AND (
        FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
        or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))

    )
    AND u.`name` = SUBSTRING_INDEX( v.principal, ";", 1 )
    AND v.principal LIKE "%;%" UNION
    SELECT
    SUBSTRING_INDEX( v.principal, ";",- 1 ) AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate
    FROM
    project p,
    volume v,
    `user` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    WHERE
    p.id = v.project_id
    AND u.id &lt;&gt; #{id}
    AND u.did = d.id
    AND u.tid = t.id
    AND (
        FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
        or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))

    )
    AND u.`name` = SUBSTRING_INDEX( v.principal, ";",- 1 )
    AND v.principal LIKE "%;%" UNION
    SELECT
    p.general AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate
    FROM
    project p,
    volume v,
    `user` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    WHERE
    (
        FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
        or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))

    )
    AND p.id = v.project_id
    AND u.id &lt;&gt; #{id}
    AND u.did = d.id
    AND u.tid = t.id
    AND u.`name` = p.general
    AND p.general NOT LIKE "%;%" UNION
    SELECT
    SUBSTRING_INDEX( p.general, ";", 1 ) AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate
    FROM
    project p,
    volume v,
    `user` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    WHERE
    (
        FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
        or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))

    )
    AND p.id = v.project_id
    AND u.id &lt;&gt; #{id}
    AND u.`name` = SUBSTRING_INDEX( p.general, ";", 1 )
    AND p.general LIKE "%;%" UNION
    SELECT
    SUBSTRING_INDEX( p.general, ";", - 1 ) AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate
    FROM
    project p,
    volume v,
    `user` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    WHERE
    (
        FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
        or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))

    )
    AND p.id = v.project_id
    AND u.id &lt;&gt; #{id}
    AND u.did = d.id
    AND u.tid = t.id
    AND u.`name` = SUBSTRING_INDEX( p.general, ";", - 1 )
    AND p.general LIKE "%;%"
  </select>
  <select id="queryByManager" resultType="java.util.Map">
    select *
    from (select
    u.name AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate
    from
    `user` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    where
    d.id = #{did}
    AND u.id &lt;&gt; #{id}
    and d.id= u.did
    and u.tid = t.id
    union
    SELECT
    v.designer AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate
    FROM
    volume v,
    project p,
    `USER` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    WHERE
    p.id = v.project_id
    AND u.`name` = v.designer
    AND u.id &lt;&gt; #{id}
    AND u.did = d.id
    AND u.tid = t.id
    AND (
    FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
    or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))

    )
    AND ((
    v.shot_date != ""
    AND ( v.planned_start_date >= #{sqlDate} OR v.start_date >= #{sqlDate} OR v.shot_date >= #{sqlDate} OR v.actual_publication_date >= #{sqlDate} ))
    OR ( v.shot_date = "" AND v.start_date != "" )) UNION
    SELECT
    principal AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate
    FROM
    project p,
    volume v,
    `user` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    WHERE

     (
    FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
    or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))

    )
    AND p.id = v.project_id
    AND u.id &lt;&gt; #{id}
    AND u.did = d.id
    AND u.tid = t.id
    AND u.`name` = v.principal
    AND v.principal NOT LIKE "%;%" UNION
    SELECT
    SUBSTRING_INDEX( v.principal, ";", 1 ) AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate
    FROM
    volume v,
    project p,
    `user` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    WHERE
    p.id = v.project_id
    AND u.id &lt;&gt; #{id}
    AND u.did = d.id
    AND u.tid = t.id
    AND (
    FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
    or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))

    )
    AND u.`name` = SUBSTRING_INDEX( v.principal, ";", 1 )
    AND v.principal LIKE "%;%" UNION
    SELECT
    SUBSTRING_INDEX( v.principal, ";",- 1 ) AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate
    FROM
    project p,
    volume v,
    `user` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    WHERE
    p.id = v.project_id
    AND u.id &lt;&gt; #{id}
    AND u.did = d.id
    AND u.tid = t.id
    AND (
     FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
    or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))

    )
    AND u.`name` = SUBSTRING_INDEX( v.principal, ";",- 1 )
    AND v.principal LIKE "%;%" UNION
    SELECT
    p.general AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate
    FROM
    project p,
    volume v,
    `user` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    WHERE
    (
     FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
    or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))

    )
    AND p.id = v.project_id
    AND u.id &lt;&gt; #{id}
    AND u.did = d.id
    AND u.tid = t.id
    AND u.`name` = p.general
    AND p.general NOT LIKE "%;%" UNION
    SELECT
    SUBSTRING_INDEX( p.general, ";", 1 ) AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate
    FROM
    project p,
    volume v,
    `user` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    WHERE
    (
     FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
    or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))

    )
    AND p.id = v.project_id
    AND u.id &lt;&gt; #{id}
    AND u.`name` = SUBSTRING_INDEX( p.general, ";", 1 )
    AND p.general LIKE "%;%" UNION
    SELECT
    SUBSTRING_INDEX( p.general, ";", - 1 ) AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate
    FROM
    project p,
    volume v,
    `user` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    WHERE
    (
     FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
    or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))

    )
    AND p.id = v.project_id
    AND u.id &lt;&gt; #{id}
    AND u.did = d.id
    AND u.tid = t.id
    AND u.`name` = SUBSTRING_INDEX( p.general, ";", - 1 )
    AND p.general LIKE "%;%"
    union
    select
    u.name AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate
    from
    score_manage sm,
    `user` u left join
    user_score us on u.id = score_id and grade_id = #{id},
    department d,
    technology t
    where
    sm.score_id = #{id}
    and sm.scored_id = u.id
    and u.did = d.id
    and u.tid = t.id
    and sm.state = 0
    ) as d
    <where>
      not exists(
      select id
      from score_manage sm
      where sm.score_id = #{id}
      and sm.scored_id = d.id
      and sm.state = 1
      )
    <if test="selectName != null and selectName != ''">
      and (d.name like concat("%",#{selectName},"%")
      or
        d.username like concat("%",#{selectName},"%"))
    </if>
  </where>
  </select>
  <select id="queryByHeadman" resultType="java.util.Map">
    select *
    from (
   select
    u.name AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate
    from
    `user` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    where
    t.id = #{tid}
    AND u.id &lt;&gt; #{id}
    and d.id= u.did
    and u.tid = t.id
    union
        SELECT
    v.designer AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate
    FROM
    volume v,
    project p,
    `USER` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    WHERE
    p.id = v.project_id
    AND u.`name` = v.designer
    AND u.id &lt;&gt; #{id}
    AND u.did = d.id
    AND u.tid = t.id
    AND (
    v.principal = #{name}

    OR SUBSTRING_INDEX( v.principal, ";", 1 )= #{name}

    OR SUBSTRING_INDEX( v.principal, ";",-1 )= #{name}

    OR p.general = #{name}

    OR SUBSTRING_INDEX( p.general, ";", 1 )= #{name}

    OR SUBSTRING_INDEX( p.general, ";",-1 )= #{name}

    )
    AND ((
    v.shot_date != ""
    AND ( v.planned_start_date >= #{sqlDate} OR v.start_date >= #{sqlDate} OR v.shot_date >= #{sqlDate} OR v.actual_publication_date >= #{sqlDate} ))
    OR ( v.shot_date = "" AND v.start_date != "" )) UNION
    SELECT
    principal AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate
    FROM
    project p,
    volume v,
    `user` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    WHERE

     (
     FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
    or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))

    )
    AND p.id = v.project_id
    AND u.id &lt;&gt; #{id}
    AND u.did = d.id
    AND u.tid = t.id
    AND u.`name` = v.principal
    AND v.principal NOT LIKE "%;%" UNION
    SELECT
    SUBSTRING_INDEX( v.principal, ";", 1 ) AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate
    FROM
    volume v,
    project p,
    `user` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    WHERE
    p.id = v.project_id
    AND u.id &lt;&gt; #{id}
    AND u.did = d.id
    AND u.tid = t.id
    AND (
     FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
    or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))

    )
    AND u.`name` = SUBSTRING_INDEX( v.principal, ";", 1 )
    AND v.principal LIKE "%;%" UNION
    SELECT
    SUBSTRING_INDEX( v.principal, ";",- 1 ) AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate
    FROM
    project p,
    volume v,
    `user` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    WHERE
    p.id = v.project_id
    AND u.id &lt;&gt; #{id}
    AND u.did = d.id
    AND u.tid = t.id
    AND (
     FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
    or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))

    )
    AND u.`name` = SUBSTRING_INDEX( v.principal, ";",- 1 )
    AND v.principal LIKE "%;%" UNION
    SELECT
    p.general AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate
    FROM
    project p,
    volume v,
    `user` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    WHERE
    (
     FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
    or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))

    )
    AND p.id = v.project_id
    AND u.id &lt;&gt; #{id}
    AND u.did = d.id
    AND u.tid = t.id
    AND u.`name` = p.general
    AND p.general NOT LIKE "%;%" UNION
    SELECT
    SUBSTRING_INDEX( p.general, ";", 1 ) AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate
    FROM
    project p,
    volume v,
    `user` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    WHERE
    (
     FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
    or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))

    )
    AND p.id = v.project_id
    AND u.id &lt;&gt; #{id}
    AND u.`name` = SUBSTRING_INDEX( p.general, ";", 1 )
    AND p.general LIKE "%;%" UNION
    SELECT
    SUBSTRING_INDEX( p.general, ";", - 1 ) AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate
    FROM
    project p,
    volume v,
    `user` u
    LEFT JOIN user_score us ON us.grade_id = #{id}
    AND u.id = us.score_id,
    department d,
    technology t
    WHERE
    (
     FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
    or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))

    )
    AND p.id = v.project_id
    AND u.id &lt;&gt; #{id}
    AND u.did = d.id
    AND u.tid = t.id
    AND u.`name` = SUBSTRING_INDEX( p.general, ";", - 1 )
    AND p.general LIKE "%;%"
    union
    select
    u.name AS `name`,
    u.id,
    u.username,
    d.name AS department,
    t.name AS technology,
    us.designer,
    us.personal,
    us.coordinate
    from
    score_manage sm,
    `user` u left join
    user_score us on u.id = score_id and grade_id = #{id},
    department d,
    technology t
    where
    sm.score_id = #{id}
    and sm.scored_id = u.id
    and u.did = d.id
    and u.tid = t.id
    and sm.state = 0
    ) as d
    <where>
      not exists(
      select id
      from score_manage sm
      where sm.score_id = #{id}
      and sm.scored_id = d.id
      and sm.state = 1
      )
      <if test="selectName != null and selectName != ''">
        and (d.name like concat("%",#{selectName},"%")
        or
        d.username like concat("%",#{selectName},"%"))
      </if>
    </where>
  </select>
  <select id="queryByGAndPList" resultType="java.lang.String">
  select mark
  from (
    SELECT
      u.id, CONCAT_WS("-",u.did,u.tid,u.id) as mark
    FROM
      volume v,
      project p,
      `USER` u
    WHERE
      p.id = v.project_id
      AND u.`name` = v.designer
      AND u.id &lt;&gt;#{id}
    AND (
     FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
    or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))

    )
    AND ((
    v.shot_date != ""
    AND (
    v.planned_start_date >= #{sqlDate} OR v.start_date >= #{sqlDate} OR v.shot_date >= #{sqlDate} OR v.actual_publication_date >= #{sqlDate} ))
    OR ( v.shot_date = "" AND v.start_date != "" )) UNION
    SELECT
      u.id,CONCAT_WS("-",u.did,u.tid,u.id) as mark
    FROM
      project p,
      volume v,
      `user` u
    WHERE
      (
          FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
          or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))
        )
      AND p.id = v.project_id
      AND u.id &lt;&gt;#{id}
    AND u.`name` = v.principal
		AND v.principal NOT LIKE "%;%" UNION
    SELECT
      u.id,CONCAT_WS("-",u.did,u.tid,u.id) as mark
    FROM
      volume v,
      project p,
      `user` u
    WHERE
      p.id = v.project_id
      AND u.id &lt;&gt;#{id}
    AND (
        FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
        or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))
    )
    AND u.`name` = SUBSTRING_INDEX( v.principal, ";", 1 )
    AND v.principal LIKE "%;%" UNION
    SELECT
      u.id,CONCAT_WS("-",u.did,u.tid,u.id) as mark
    FROM
      project p,
      volume v,
      `user` u
    WHERE
      p.id = v.project_id
      AND u.id &lt;&gt;#{id}
    AND (
        FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
        or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))
    )
    AND u.`name` = SUBSTRING_INDEX( v.principal, ";",- 1 )
    AND v.principal LIKE "%;%" UNION
    SELECT
      u.id,CONCAT_WS("-",u.did,u.tid,u.id) as mark
    FROM
      project p,
      volume v,
      `user` u
    WHERE
      (
     FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
    or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))
        )
      AND p.id = v.project_id
      AND u.id &lt;&gt;#{id}
    AND u.`name` = p.general
		AND p.general NOT LIKE "%;%" UNION
    SELECT
      u.id,CONCAT_WS("-",u.did,u.tid,u.id) as mark
    FROM
      project p,
      volume v,
      `user` u
    WHERE
      (
     FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
    or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))
        )
      AND p.id = v.project_id
      AND u.id &lt;&gt;#{id}

    AND u.`name` = SUBSTRING_INDEX( p.general, ";", 1 )
		AND p.general LIKE "%;%" UNION
    SELECT
      u.id,CONCAT_WS("-",u.did,u.tid,u.id) as mark
    FROM
      project p,
      volume v,
      `user` u
    WHERE
      (
     FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
    or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))
        )
      AND p.id = v.project_id
      AND u.id &lt;&gt;#{id}
    AND u.`name` = SUBSTRING_INDEX( p.general, ";", - 1 )
		AND p.general LIKE "%;%" UNION
    SELECT
      u.id,CONCAT_WS("-",u.did,u.tid,u.id) as mark
    FROM
      score_manage sm,
      `user` u
    WHERE
      sm.score_id = #{id}
      AND sm.scored_id = u.id
      AND sm.state = 0) as d
    where
    not exists(
    select id
    from score_manage sm
    where sm.score_id = #{id}
    and sm.scored_id = d.id
    and sm.state = 1
    )
  </select>
  <select id="queryNotSelfList" resultType="java.lang.String">
    select distinct CONCAT_WS("-",u.did,u.tid,u.id)
    from `user` u
    where u.id &lt;&gt; #{id}
      and not exists(
      select id
      from score_manage sm
      where sm.score_id = #{id}
        and sm.scored_id = u.id
        and sm.state = 1
      )
  </select>
  <select id="queryByManagerList" resultType="java.lang.String">
    select mark
    from(
          SELECT
            u.id,CONCAT_WS("-",u.did,u.tid,u.id) as mark
          FROM
            `user` u department d
          WHERE
            d.id = #{did}

            AND u.id &lt;&gt;#{id}

    AND d.id = u.did UNION
    SELECT
      u.id,CONCAT_WS("-",u.did,u.tid,u.id) as mark
    FROM
      volume v,
      project p,
      `USER` u
    WHERE
      p.id = v.project_id
      AND u.`name` = v.designer
      AND u.id &lt;&gt;#{id}

    AND (
            FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
       or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))

    )
    AND ((
    v.shot_date != ""
    AND (
    v.planned_start_date >= #{sqlDate} OR v.start_date >= #{sqlDate} OR v.shot_date >= #{sqlDate} OR v.actual_publication_date >= #{sqlDate} ))

    OR ( v.shot_date = "" AND v.start_date != "" )) UNION
    SELECT
      u.id,CONCAT_WS("-",u.did,u.tid,u.id) as mark
    FROM
      project p,
      volume v,
      `user` u
    WHERE
      (
            FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
       or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))

        )
      AND p.id = v.project_id
      AND u.id &lt;&gt;#{id}

    AND u.`name` = v.principal
		AND v.principal NOT LIKE "%;%" UNION
    SELECT
      u.id,CONCAT_WS("-",u.did,u.tid,u.id) as mark
    FROM
      volume v,
      project p,
      `user` u
    WHERE
      p.id = v.project_id
      AND u.id &lt;&gt;#{id}

    AND (
            FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
       or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))

    )
    AND u.`name` = SUBSTRING_INDEX( v.principal, ";", 1 )
    AND v.principal LIKE "%;%" UNION
    SELECT
      u.id,CONCAT_WS("-",u.did,u.tid,u.id) as mark
    FROM
      project p,
      volume v,
      `user` u
    WHERE
      p.id = v.project_id
      AND u.id &lt;&gt;#{id}

    AND (
            FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
       or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))

    )
    AND u.`name` = SUBSTRING_INDEX( v.principal, ";",- 1 )
    AND v.principal LIKE "%;%" UNION
    SELECT
      u.id,CONCAT_WS("-",u.did,u.tid,u.id) as mark
    FROM
      project p,
      volume v,
      `user` u
    WHERE
      (
            FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
       or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))

        )
      AND p.id = v.project_id
      AND u.id &lt;&gt;#{id}

    AND u.`name` = p.general
		AND p.general NOT LIKE "%;%" UNION
    SELECT
      u.id,CONCAT_WS("-",u.did,u.tid,u.id) as mark
    FROM
      project p,
      volume v,
      `user` u
    WHERE
      (
            FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
       or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))

        )
      AND p.id = v.project_id
      AND u.id &lt;&gt;#{id}

    AND u.`name` = SUBSTRING_INDEX( p.general, ";", 1 )
		AND p.general LIKE "%;%" UNION
    SELECT
      u.id,CONCAT_WS("-",u.did,u.tid,u.id) as mark
    FROM
      project p,
      volume v,
      `user` u
    WHERE
      (
            FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
       or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))

        )
      AND p.id = v.project_id
      AND u.id &lt;&gt;#{id}

    AND u.`name` = SUBSTRING_INDEX( p.general, ";", - 1 )
		AND p.general LIKE "%;%" UNION
    SELECT
      u.id,CONCAT_WS("-",u.did,u.tid,u.id) as mark
    FROM
      score_manage sm,
      `user` u
    WHERE
      sm.score_id = #{id}

      AND sm.scored_id = u.id
      AND sm.state = 0
          ) as d
    where

  </select>
  <select id="queryByHeadmanList" resultType="java.lang.String">
    SELECT
      mark
    FROM
      (
        SELECT
          u.id,CONCAT_WS("-",u.did,u.tid,u.id) as mark
        FROM
          `user` u,
          technology t
        WHERE
          t.id = #{tid}

          AND u.id &lt;&gt;#{id}
          AND u.tid = t.id UNION
        SELECT
          u.id
        FROM
          volume v,
          project p,
          `USER` u
        WHERE
          p.id = v.project_id
          AND u.`name` = v.designer
          AND u.id &lt;&gt;#{id}
    AND (
            FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
            or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))

    )
    AND ((
    v.shot_date != ""
    AND (
    v.planned_start_date >= #{sqlDate} OR v.start_date >= #{sqlDate} OR v.shot_date >= #{sqlDate} OR v.actual_publication_date >= #{sqlDate} ))

    OR ( v.shot_date = "" AND v.start_date != "" )) UNION
    SELECT
      u.id,CONCAT_WS("-",u.did,u.tid,u.id) as mark
    FROM
      project p,
      volume v,
      `user` u
    WHERE
      (
          FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
          or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))

        )
      AND p.id = v.project_id
      AND u.id &lt;&gt;#{id}
    AND u.`name` = v.principal
			AND v.principal NOT LIKE "%;%" UNION
    SELECT
      u.id,CONCAT_WS("-",u.did,u.tid,u.id) as mark
    FROM
      volume v,
      project p,
      `user` u
    WHERE
      p.id = v.project_id
      AND u.id &lt;&gt;#{id}
    AND (
        FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
        or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))

    )
    AND u.`name` = SUBSTRING_INDEX( v.principal, ";", 1 )
    AND v.principal LIKE "%;%" UNION
    SELECT
      u.id,CONCAT_WS("-",u.did,u.tid,u.id) as mark
    FROM
      project p,
      volume v,
      `user` u
    WHERE
      p.id = v.project_id
      AND u.id &lt;&gt;#{id}
    AND (
        FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
        or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))

    )
    AND u.`name` = SUBSTRING_INDEX( v.principal, ";",- 1 )
    AND v.principal LIKE "%;%" UNION
    SELECT
      u.id,CONCAT_WS("-",u.did,u.tid,u.id) as mark
    FROM
      project p,
      volume v,
      `user` u
    WHERE
      (
          FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
          or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))

        )
      AND p.id = v.project_id
      AND u.id &lt;&gt;#{id}
    AND u.`name` = p.general
			AND p.general NOT LIKE "%;%" UNION
    SELECT
      u.id,CONCAT_WS("-",u.did,u.tid,u.id) as mark
    FROM
      project p,
      volume v,
      `user` u
    WHERE
      (
          FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
          or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))

        )
      AND p.id = v.project_id
      AND u.id &lt;&gt;#{id}
    AND u.`name` = SUBSTRING_INDEX( p.general, ";", 1 )
			AND p.general LIKE "%;%" UNION
    SELECT
      u.id,CONCAT_WS("-",u.did,u.tid,u.id) as mark
    FROM
      project p,
      volume v,
      `user` u
    WHERE
      (
          FIND_IN_SET(#{name},REPLACE (`general`, ";", "," ))
          or FIND_IN_SET(#{name},REPLACE (`principal`, ";", "," ))

        )
      AND p.id = v.project_id
      AND u.id &lt;&gt;#{id}
    AND u.`name` = SUBSTRING_INDEX( p.general, ";", - 1 )
			AND p.general LIKE "%;%" UNION
    SELECT
      u.id,CONCAT_WS("-",u.did,u.tid,u.id) as mark
    FROM
      score_manage sm,
      `user` u
    WHERE
      sm.score_id = #{id}
      AND sm.scored_id = u.id
      AND sm.state = 0
      ) AS d
    WHERE
      NOT EXISTS (
      SELECT
      id
      FROM
      score_manage sm
      WHERE
      sm.score_id = #{id}
      AND sm.scored_id = d.id
      AND sm.state = 1
      )
  </select>


</mapper>
